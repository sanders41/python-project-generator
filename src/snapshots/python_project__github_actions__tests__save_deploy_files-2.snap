---
source: src/github_actions.rs
expression: production_content
---
"name: Deploy to Production\non:\n  release:\n    types:\n      - published\njobs:\n  deploy:\n    runs-on:\n      - self-hosted\n      - production\n    env:\n      ENVIRONMENT: production\n      DOMAIN: ${{ secrets.DOMAIN_PRODUCTION }}\n      STACK_NAME: ${{ secrets.STACK_NAME_PRODUCTION }}\n      SECRET_KEY: ${{ secrets.SECRET_KEY }}\n      FIRST_SUPERUSER_EMAIL: ${{ secrets.FIRST_SUPERUSER_EMAIL }}\n      FIRST_SUPERUSER_PASSWORD: ${{ secrets.FIRST_SUPERUSER_PASSWORD }}\n      FIRST_SUPERUSER_NAME: ${{ secrets.FIRST_SUPERUSER_NAME }}\n      POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}\n      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}\n      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}\n      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}\n      VALKEY_HOST: ${{ secrets.VALKEY_HOST }}\n      VALKEY_PASSWORD: ${{ secrets.VALKEY_PASSWORD }}\n      USERNAME: ${{ secrets.FIRST_SUPERUSER_EMAIL }}\n      PASSWORD: ${{ secrets.FIRST_SUPERUSER_PASSWORD }}\n      EMAIL: ${{ secrets.FIRST_SUPERUSER_EMAIL }}\n      LOG_LEVEL: \"INFO\"\n    steps:\n      - name: Fix permissions\n        run: |\n          if [ -d \"./data\" ]; then\n            sudo chown -R $USER:$USER ./data\n          fi\n      - name: Checkout\n        uses: actions/checkout@v5\n      - name: Create .env file\n        run: |\n          HASHED_PASSWORD=$(openssl passwd -apr1 \"${PASSWORD}\" | sed 's/\\$/\\$\\$/g')\n          cat > .env << EOF\n          ENVIRONMENT=${ENVIRONMENT}\n          DOMAIN=${DOMAIN}\n          STACK_NAME=${STACK_NAME}\n          SECRET_KEY=${SECRET_KEY}\n          FIRST_SUPERUSER_EMAIL=${FIRST_SUPERUSER_EMAIL}\n          FIRST_SUPERUSER_PASSWORD=${FIRST_SUPERUSER_PASSWORD}\n          FIRST_SUPERUSER_NAME=${FIRST_SUPERUSER_NAME}\n          POSTGRES_HOST=${POSTGRES_HOST}\n          POSTGRES_USER=${POSTGRES_USER}\n          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}\n          POSTGRES_DB=${POSTGRES_DB}\n          VALKEY_HOST=${VALKEY_HOST}\n          VALKEY_PASSWORD=${VALKEY_PASSWORD}\n          USERNAME=${FIRST_SUPERUSER_EMAIL}\n          PASSWORD=${FIRST_SUPERUSER_PASSWORD}\n          HASHED_PASSWORD=${HASHED_PASSWORD}\n          EMAIL=${FIRST_SUPERUSER_EMAIL}\n          LOG_LEVEL=${LOG_LEVEL}\n          EOF\n      - name: Build and restart containers\n        timeout-minutes: 15\n        run: |\n          docker compose -f docker-compose.yml --project-name ${{ secrets.STACK_NAME_PRODUCTION }} build\n          docker compose -f docker-compose.yml --project-name ${{ secrets.STACK_NAME_PRODUCTION }} up -d\n"
